---
title: "RAProject"
author: "Mingzhi Ye"
date: "2022/10/10"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include = FALSE}
library(VDJdive)
library(tidyverse)
require(SingleCellExperiment)
library(r2r)
library(philentropy)
```


# Get the combined distribution of number of Alpha chains and number of Beta chains in a clonotype
```{r}
IndexnAnBMap=rbind(c(0, 0), c(0, 1), c(0, 2), c(1, 0), c(1, 1), c(1, 2), c(2, 0), c(2, 1), c(2, 2))
nAnBWeight=c(0, 12382, 0, 2813, 71977, 2194, 0, 7129, 566)
```

# Get a template dataframe of a clonotype which has one alpha chain and one beta chain
```{r}
sce0 <- readRDS('toyTCRdata.rds')
TemplateClonotype=sce0$contigs[[4]][c(2,1),]
```

# Generate a CDR3
```{r}

AmiNoAcids=c('A','R','N','D','C','Q','E','G','H','I','L','K','M','F','P','S','T','W','Y','V')
getCDR3 <- function(x){
  
  cdr3=sample(AmiNoAcids,15, replace=T)
  return(paste(cdr3,collapse = ''))
}
```


# Generate a Clonotype in sample pool
```{r}
getClonotypeForPool<-function(clonotype_index, CDRAlpha, CDRBeta){
    result=TemplateClonotype
    result$cdr3[1]=CDRAlpha
    result$cdr3[2]=CDRBeta
    return(result)
}
```



# Generate sample pool
```{r}
getSamplePool <- function(poolSize){

    
    

    Alpha_pool=sapply(1:poolSize,getCDR3,simplify = TRUE)
    Beta_pool=sapply(1:poolSize,getCDR3,simplify = TRUE)
    
    CDR_Alpha=sample(Alpha_pool,poolSize, replace=T)
    CDR_Beta=sample(Beta_pool,poolSize, replace=T)
    
    
  

    barcode <- paste('cell', 1:poolSize)
    
    
    samplePool <- lapply(1:poolSize, function(clonotype_index){
        getClonotypeForPool(clonotype_index, CDR_Alpha[clonotype_index], CDR_Beta[clonotype_index])
    })
    samplePool <- SplitDataFrameList(samplePool)
    samplePool[,'barcode'] <- barcode
    samplePool[,'sample'] <- 'sim'
    names(samplePool) <- barcode
 
    # sample1<-as(sample,'SplitDFrameList')
    return(samplePool)
    
}
#samplePool=getSamplePool(poolSize)
```



# Functions for generate a sample
```{r}
getClonotype<-function(clonotype_index, numberA, numberB, DistributionOfClonotypes, samplePool, poolSize, errorProb = .01){
    result=DataFrame()
    indexInPool=sample(1:poolSize, 3, replace=FALSE, prob=DistributionOfClonotypes)
    setAlpha <- hashset()
    setBeta <- hashset()

    if (numberA>=1){
        if(runif(1) < errorProb){
          result=rbind(result,samplePool[[indexInPool[2]]][1,])
          insert(setAlpha,indexInPool[2])
        }else{
          result=rbind(result,samplePool[[indexInPool[1]]][1,])
          insert(setAlpha,indexInPool[1])
        }
        numberA=numberA-1
    }
    if (numberB>=1){
        if(runif(1) < errorProb){
          result=rbind(result,samplePool[[indexInPool[3]]][2,])
          insert(setBeta,indexInPool[3])
        }else{
          result=rbind(result,samplePool[[indexInPool[1]]][2,])
          insert(setBeta,indexInPool[1])
        }

        numberB=numberB-1
    }
    while(numberA>0){
        indexInPool=sample(1:poolSize, 1, replace=FALSE, prob=DistributionOfClonotypes)
        while(setAlpha[indexInPool]==TRUE){
          indexInPool=sample(1:poolSize, 1, replace=FALSE, prob=DistributionOfClonotypes)
        }
        insert(setAlpha,indexInPool)
        result=rbind(result,samplePool[[indexInPool]][1,])
        numberA=numberA-1

        
    }
    while(numberB>0){
        indexInPool=sample(1:poolSize, 1, replace=FALSE, prob=DistributionOfClonotypes)
        while(setBeta[indexInPool]==TRUE){
          indexInPool=sample(1:poolSize, 1, replace=FALSE, prob=DistributionOfClonotypes)
        }
        insert(setBeta,indexInPool)
        result=rbind(result,samplePool[[indexInPool]][2,])
        numberB=numberB-1
        

    }
    return(result)
    
}
```

# Use the functions to generate a sample with size 50


```{r}
getSample <- function(samplesize,DistributionOfClonotypes,samplePool, poolSize){
    RandomIntegers <- sample(1:(length(IndexnAnBMap)/2), samplesize, replace=T, prob=nAnBWeight)

    barcode <- paste('cell', 1:samplesize)
    
    
    sample <- lapply(1:samplesize, function(clonotype_index){
        getClonotype(clonotype_index, IndexnAnBMap[RandomIntegers[clonotype_index],1], IndexnAnBMap[RandomIntegers[clonotype_index],2], DistributionOfClonotypes, samplePool, poolSize)
    })
    sample <- SplitDataFrameList(sample)
    sample[,'barcode'] <- barcode
    sample[,'sample'] <- 'sim'
    names(sample) <- barcode
 
    # sample1<-as(sample,'SplitDFrameList')
    return(sample)
    
}
# samplelist=getSample(SampleSize)
# EMpredicted <- clonoStats(samplelist, method = 'EM')
# UNpredicted <- clonoStats(samplelist, method = 'unique')



```

#Merge the dataframe
```{r}
getMerged<-function(clonotype,abundance,merged){
  stimulated<- data.frame(clonotype,abundance)

  sum_abundance=sum(stimulated['abundance'])
  stimulated['abundance']=stimulated['abundance']/sum_abundance
  
  merged = merge(x = merged, y = stimulated, by = "clonotype",all = TRUE)
  merged[is.na(merged)] <- 0
  return(merged)
}

```

# Generate table
```{r,warning=FALSE}
getResultTable <- function(poolSize,SampleSize,RepeatTimes){
  DistributionOfClonotypes=0.8^(1:poolSize)
  minimum_bound=rep(1e-7,poolSize)
  DistributionOfClonotypes <- pmax(DistributionOfClonotypes, minimum_bound)
  samplePool=getSamplePool(poolSize)
  
  # Generate the dataframe recording the abundance for each clonotype in the sample pool
  clonotypes_in_pool=samplePool[,'cdr3']
  
  concatCDR3<-function(x){
    res=paste(x[1],x[2],sep=' ')
      res=paste(x[1],x[2],sep=' ')
      return(res)
  }
  clonotypes_in_pool=lapply(clonotypes_in_pool,concatCDR3)
  clonotypes_in_pool=unlist(clonotypes_in_pool)
  Sum_of_Repeat=sum(DistributionOfClonotypes)
  abundance=DistributionOfClonotypes/Sum_of_Repeat
  realDF<- data.frame(clonotypes_in_pool,abundance)
  rownames(realDF) <- NULL
  realDF=aggregate(realDF$abundance, by=list(clonotype=realDF$clonotypes_in_pool ), FUN=sum)
  colnames(realDF) <- c('clonotype','abundance')
  
  merged=realDF
  for(i in 1:RepeatTimes){
    samplelist=getSample(SampleSize,DistributionOfClonotypes, samplePool, poolSize)
    
    
    EMpredicted <- clonoStats(samplelist, method = 'EM')
    merged= getMerged(clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1],merged)

    
    UNpredicted <- clonoStats(samplelist, method = 'unique')
    merged= getMerged(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],merged)

  }
  ColumnNames=rep(c('EM','UN'),RepeatTimes)
  ColumnIndexes=rep(1:RepeatTimes,each=2)
  ColumnNames=paste(ColumnNames,ColumnIndexes,sep='_')
  ColumnNames=c('clonotype','Real', ColumnNames)
  names(merged)<-ColumnNames
  return(merged)
}

#Intermediate=getResultTable(200,500,3)
```


# Get Variation Distance

```{r, message = FALSE, warning = FALSE}
getDistance_R<-function(clonotype,abundance,realDF){
  stimulated<- data.frame(clonotype,abundance)

  sum_abundance=sum(stimulated['abundance'])
  stimulated['abundance']=stimulated['abundance']/sum_abundance
  
  merged = merge(x = realDF, y = stimulated, by = "clonotype",all = TRUE)
  merged[is.na(merged)] <- 0
  return (sum(abs(merged['abundance.x']-merged['abundance.y'])))
}

```



# Calculate distances for samples

```{r,message = FALSE,warning = FALSE}
getDistanceDataFrame <- function(poolSize,SampleSize,RepeatTimes){
  DistributionOfClonotypes=1/(1:poolSize)
  samplePool=getSamplePool(poolSize)
  
  # Generate the dataframe recording the abundance for each clonotype in the sample pool
  clonotypes_in_pool=samplePool[,'cdr3']
  
  concatCDR3<-function(x){
    res=paste(x[1],x[2],sep=' ')
      res=paste(x[1],x[2],sep=' ')
      return(res)
  }
  clonotypes_in_pool=lapply(clonotypes_in_pool,concatCDR3)
  clonotypes_in_pool=unlist(clonotypes_in_pool)
  Sum_of_Repeat=sum(DistributionOfClonotypes)
  abundance=DistributionOfClonotypes/Sum_of_Repeat
  realDF<- data.frame(clonotypes_in_pool,abundance)
  rownames(realDF) <- NULL
  realDF=aggregate(realDF$abundance, by=list(clonotype=realDF$clonotypes_in_pool ), FUN=sum)
  colnames(realDF) <- c('clonotype','abundance')
  
  DistanceListFromEM=c()
  DistanceListFromUN=c()
  for(i in 1:RepeatTimes){
    samplelist=getSample(SampleSize,DistributionOfClonotypes, samplePool, poolSize)
    
    
    EMpredicted <- clonoStats(samplelist, method = 'EM')
    distance1=getDistance_R(clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1],realDF)
    DistanceListFromEM[i]=distance1

    
    UNpredicted <- clonoStats(samplelist, method = 'unique')
    distance2=getDistance_R(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],realDF)
    DistanceListFromUN[i]=distance2

  }

  return(data.frame(DistanceListFromUN,DistanceListFromEM))
}
#ResultDistances=getDistanceDataFrame(200,500,10)

```
# Get KL Divergence

```{r, message = FALSE, warning = FALSE}
getKLDivergence<-function(clonotype,abundance,realDF){
  stimulated<- data.frame(clonotype,abundance)

  sum_abundance=sum(stimulated['abundance'])
  stimulated['abundance']=stimulated['abundance']/sum_abundance
  
  merged = merge(x = realDF, y = stimulated, by = "clonotype",all = TRUE)
  merged[is.na(merged)] <- 0
  RES=KL(rbind(merged[['abundance.y']],merged[['abundance.x']]),epsilon=1e-20)
  return(RES)
}

```

# Get JS Divergence

```{r, message = FALSE, warning = FALSE}
getJSDivergence<-function(clonotype,abundance,realDF){
  stimulated<- data.frame(clonotype,abundance)

  sum_abundance=sum(stimulated['abundance'])
  stimulated['abundance']=stimulated['abundance']/sum_abundance
  
  merged = merge(x = realDF, y = stimulated, by = "clonotype",all = TRUE)
  merged[is.na(merged)] <- 0
  RES=JSD(rbind(merged[['abundance.y']],merged[['abundance.x']]))
  return(RES)
}

```

# Get Distance between two predict methods

```{r, message = FALSE, warning = FALSE}
getDistanceEM_UN<-function(clonotype1,abundance1,clonotype2,abundance2){
  stimulated1<- data.frame(clonotype1,abundance1)
  stimulated2<- data.frame(clonotype2,abundance2)
  
  colnames(stimulated1) <- c('clonotype','abundance')
  colnames(stimulated2) <- c('clonotype','abundance')

  sum_abundance1=sum(stimulated1['abundance'])
  sum_abundance2=sum(stimulated2['abundance'])
  
  stimulated1['abundance']=stimulated1['abundance']/sum_abundance1
  stimulated2['abundance']=stimulated2['abundance']/sum_abundance2

  

  merged = merge(x = stimulated1, y = stimulated2, by = "clonotype",all = TRUE)
  merged[is.na(merged)] <- 0
  return (sum(abs(merged['abundance.x']-merged['abundance.y'])))
}
```

# Calculate distance and KL Divergence for samples

```{r,message = FALSE,warning = FALSE}
getEvaluationDataFrame <- function(poolSize,SampleSize,RepeatTimes){
  DistributionOfClonotypes=1/(1:poolSize)
  samplePool=getSamplePool(poolSize)
  
  # Generate the dataframe recording the abundance for each clonotype in the sample pool
  clonotypes_in_pool=samplePool[,'cdr3']
  
  concatCDR3<-function(x){
    res=paste(x[1],x[2],sep=' ')
      res=paste(x[1],x[2],sep=' ')
      return(res)
  }
  clonotypes_in_pool=lapply(clonotypes_in_pool,concatCDR3)
  clonotypes_in_pool=unlist(clonotypes_in_pool)
  Sum_of_Repeat=sum(DistributionOfClonotypes)
  abundance=DistributionOfClonotypes/Sum_of_Repeat
  realDF<- data.frame(clonotypes_in_pool,abundance)
  rownames(realDF) <- NULL
  realDF=aggregate(realDF$abundance, by=list(clonotype=realDF$clonotypes_in_pool), FUN=sum)
  colnames(realDF) <- c('clonotype','abundance')
  

  DistanceListFromEM=c()
  DistanceListFromUN=c()
  KLDivergenceListFromEM=c()
  KLDivergenceListFromUN=c()
  JSDivergenceListFromEM=c()
  JSDivergenceListFromUN=c()
  DistanceEM_UN=c()
  
  for(i in 1:RepeatTimes){
    samplelist=getSample(SampleSize,DistributionOfClonotypes, samplePool, poolSize)
    
    
    EMpredicted <- clonoStats(samplelist, method = 'EM')
    
    distance1=getDistance_R(clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1],realDF)
    DistanceListFromEM[i]=distance1
    distance1=getKLDivergence(clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1],realDF)
    KLDivergenceListFromEM[i]=distance1
    distance1=getJSDivergence(clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1],realDF)
    JSDivergenceListFromEM[i]=distance1

    
    UNpredicted <- clonoStats(samplelist, method = 'unique')
    
    distance2=getDistance_R(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],realDF)
    DistanceListFromUN[i]=distance2
    distance2=getKLDivergence(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],realDF)
    KLDivergenceListFromUN[i]=distance2
    distance2=getJSDivergence(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],realDF)
    JSDivergenceListFromUN[i]=distance2
    
    distance3=getDistanceEM_UN(clonoNames(UNpredicted),clonoAbundance(UNpredicted)[,1],clonoNames(EMpredicted),clonoAbundance(EMpredicted)[,1])
    DistanceEM_UN[i]=distance3
  }

  return(data.frame(DistanceListFromUN,DistanceListFromEM,KLDivergenceListFromUN,KLDivergenceListFromEM,JSDivergenceListFromUN,JSDivergenceListFromEM,DistanceEM_UN))
}
ResultDistances=getEvaluationDataFrame(200,500,10)

```


# Visualize
```{r,eval=FALSE}
boxplot(ResultDistances$DistanceListFromEM)
hist(ResultDistances$DistanceListFromEM)
boxplot(ResultDistances$DistanceListFromUN)
hist(ResultDistances$DistanceListFromUN)
print(median(ResultDistances$DistanceListFromEM))
print(median(ResultDistances$DistanceListFromUN))
print(mean(ResultDistances$DistanceListFromEM))
print(mean(ResultDistances$DistanceListFromUN))
```

